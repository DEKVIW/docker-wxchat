FROM node:18-alpine

# å®‰è£…SQLite
RUN apk add --no-cache sqlite

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY docker/package.json ./
# åªå®‰è£…ç”Ÿäº§ä¾èµ–ï¼Œæ¸…ç†ç¼“å­˜
RUN npm install --omit=dev && npm cache clean --force

# å¤åˆ¶æºä»£ç 
COPY docker/server.js ./
COPY public/ ./public/
COPY database/schema.sql ./database/

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /app/data /app/uploads

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤ï¼ˆç›´æ¥æ‰§è¡Œï¼Œé¿å…è„šæœ¬æ–‡ä»¶é—®é¢˜ï¼‰
CMD ["sh", "-c", "echo 'ğŸ”§ åˆå§‹åŒ–æ•°æ®åº“...' && mkdir -p /app/data /app/uploads && sqlite3 /app/data/wxchat.db < /app/database/schema.sql && echo 'âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼' && echo 'ğŸš€ å¯åŠ¨å¾®ä¿¡æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹ Dockerç‰ˆæœ¬...' && node server.js"]
